<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <style>
        .header {
            background-color: #ee4d2d;
            color: white;
            padding: 20px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
        }

        .logo a {
            color: white;
            text-decoration: none;
        }

        .search-box {
            flex: 1;
            margin: 0 50px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: none;
            border-radius: 2px;
        }

        .user-menu a {
            color: white;
            text-decoration: none;
            margin-left: 20px;
        }

        .user-menu {
            display: flex;
            align-items: center;
        }

        .user-profile {
            display: flex;
            align-items: center;
            color: white;
        }

        .user-profile>a {
            display: flex;
            align-items: center;
            color: white;
            text-decoration: none;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 8px;
            background-color: #fff;
        }

        .user-name {
            margin-right: 15px;
        }

        .nav-bar {
            background-color: white;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
        }

        .nav-bar ul {
            list-style: none;
            display: flex;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0;
        }

        .nav-bar li {
            margin-right: 30px;
        }

        .nav-bar a {
            color: #333;
            text-decoration: none;
        }
    </style>
</head>

<body>
    <div th:fragment="header">
        <style>
            .header {
                background-color: #ee4d2d;
                color: white;
                padding: 20px;
            }

            .header-top {
                display: flex;
                justify-content: space-between;
                align-items: center;
                max-width: 1200px;
                margin: 0 auto;
            }

            .logo {
                font-size: 28px;
                font-weight: bold;
            }

            .logo a {
                color: white;
                text-decoration: none;
            }

            .search-box {
                flex: 1;
                margin: 0 50px;
            }

            .search-box input {
                width: 100%;
                padding: 10px 15px;
                border: none;
                border-radius: 2px;
            }

            .user-menu a {
                color: white;
                text-decoration: none;
                margin-left: 20px;
            }

            .user-menu {
                display: flex;
                align-items: center;
            }

            .user-profile {
                display: flex;
                align-items: center;
                color: white;
            }

            .user-profile>a {
                display: flex;
                align-items: center;
                color: white;
                text-decoration: none;
            }

            .avatar {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                margin-right: 8px;
                background-color: #fff;
            }

            .user-name {
                margin-right: 15px;
            }

            .nav-bar {
                background-color: white;
                padding: 15px 20px;
                border-bottom: 1px solid #ddd;
            }

            .nav-bar ul {
                list-style: none;
                display: flex;
                max-width: 1200px;
                margin: 0 auto;
                padding: 0;
            }

            .nav-bar li {
                margin-right: 30px;
            }

            .nav-bar a {
                color: #333;
                text-decoration: none;
            }
        </style>
        <div class="header">
            <div class="header-top">
                <div class="logo"><a href="/home">ðŸ“š BookStore</a></div>
                <form class="search-box" action="/home" method="get">
                    <input type="text" name="search" th:value="${search}"
                        placeholder="Search for books, authors, publishers...">
                </form>
                <div class="user-menu">
                    <div th:if="${user}" class="user-profile">
                        <a href="/profile">
                            <img class="avatar"
                                th:src="${'https://api.dicebear.com/7.x/avataaars/svg?seed=' + user.fullname}"
                                alt="Avatar">
                            <span class="user-name" th:text="${user.fullname}">User</span>
                        </a>
                        <a href="/logout">Logout</a>
                    </div>
                    <div th:unless="${user}">
                        <a href="/register">Register</a>
                        <a href="/login">Login</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="nav-bar">
            <ul>
                <li><a href="/home">Home</a></li>
            </ul>
        </div>

        <div id="chat-fab" class="chat-fab" onclick="toggleChat()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z" />
                <path d="M7 9h10v2H7zm0-3h10v2H7z" />
            </svg>
        </div>

        <div id="chat-popup" class="chat-popup">
            <div class="chat-header">
                <span>ðŸ“š Book Assistant</span>
                <div style="display:flex;gap:8px;">
                    <button class="chat-clear" onclick="clearHistory()" title="Clear chat">ðŸ—‘</button>
                    <button class="chat-close" onclick="toggleChat()">Ã—</button>
                </div>
            </div>
            <div id="chat-messages" class="chat-messages">
                <div class="chat-message bot">
                    Hi! I'm your book assistant. Tell me what kind of book you're looking for and I'll help you find it!
                    ðŸ“–
                </div>
            </div>
            <div class="chat-input-container">
                <input type="text" id="chat-input" placeholder="Ask about books..." onkeypress="handleKeyPress(event)">
                <button class="chat-send" onclick="sendMessage()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                    </svg>
                </button>
            </div>
        </div>

        <style>
            .chat-fab {
                position: fixed;
                bottom: 24px;
                right: 24px;
                width: 60px;
                height: 60px;
                background: linear-gradient(135deg, #ee4d2d 0%, #ff6b4a 100%);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                box-shadow: 0 4px 20px rgba(238, 77, 45, 0.4);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                z-index: 1000;
            }

            .chat-fab:hover {
                transform: scale(1.1);
                box-shadow: 0 6px 28px rgba(238, 77, 45, 0.5);
            }

            .chat-popup {
                position: fixed;
                bottom: 100px;
                right: 24px;
                width: 380px;
                height: 500px;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(20px);
                border-radius: 20px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
                display: none;
                flex-direction: column;
                z-index: 1000;
                overflow: hidden;
                animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .chat-popup.active {
                display: flex;
            }

            @keyframes slideUp {
                from {
                    opacity: 0;
                    transform: translateY(20px) scale(0.95);
                }

                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            .chat-header {
                background: linear-gradient(135deg, #ee4d2d 0%, #ff6b4a 100%);
                color: white;
                padding: 16px 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-weight: 600;
                font-size: 16px;
            }

            .chat-close {
                background: none;
                border: none;
                color: white;
                font-size: 24px;
                cursor: pointer;
                padding: 0;
                line-height: 1;
                opacity: 0.8;
                transition: opacity 0.2s;
            }

            .chat-close:hover {
                opacity: 1;
            }

            .chat-clear {
                background: none;
                border: none;
                color: white;
                font-size: 16px;
                cursor: pointer;
                padding: 0;
                opacity: 0.8;
                transition: opacity 0.2s;
            }

            .chat-clear:hover {
                opacity: 1;
            }

            .chat-messages {
                flex: 1;
                padding: 16px;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .chat-message {
                max-width: 85%;
                padding: 12px 16px;
                border-radius: 16px;
                font-size: 14px;
                line-height: 1.5;
                animation: fadeIn 0.3s ease;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(8px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .chat-message.bot {
                background: linear-gradient(135deg, #f0f0f0 0%, #e8e8e8 100%);
                color: #333;
                align-self: flex-start;
                border-bottom-left-radius: 4px;
            }

            .chat-message.user {
                background: linear-gradient(135deg, #ee4d2d 0%, #ff6b4a 100%);
                color: white;
                align-self: flex-end;
                border-bottom-right-radius: 4px;
            }

            .chat-message.loading {
                background: #f0f0f0;
                align-self: flex-start;
            }

            .chat-message.loading::after {
                content: '...';
                animation: dots 1.5s infinite;
            }

            @keyframes dots {

                0%,
                20% {
                    content: '.';
                }

                40% {
                    content: '..';
                }

                60%,
                100% {
                    content: '...';
                }
            }

            .chat-input-container {
                padding: 16px;
                border-top: 1px solid rgba(0, 0, 0, 0.08);
                display: flex;
                gap: 10px;
                background: rgba(255, 255, 255, 0.8);
            }

            #chat-input {
                flex: 1;
                padding: 12px 16px;
                border: 2px solid #eee;
                border-radius: 24px;
                font-size: 14px;
                outline: none;
                transition: border-color 0.2s;
            }

            #chat-input:focus {
                border-color: #ee4d2d;
            }

            .chat-send {
                width: 44px;
                height: 44px;
                background: linear-gradient(135deg, #ee4d2d 0%, #ff6b4a 100%);
                border: none;
                border-radius: 50%;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: transform 0.2s, box-shadow 0.2s;
            }

            .chat-send:hover {
                transform: scale(1.05);
                box-shadow: 0 4px 12px rgba(238, 77, 45, 0.4);
            }

            .chat-send:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
            }
        </style>

        <script>
            var historyLoaded = false;
            function toggleChat() {
                var popup = document.getElementById('chat-popup');
                popup.classList.toggle('active');
                if (popup.classList.contains('active')) {
                    if (!historyLoaded) {
                        loadHistory();
                        historyLoaded = true;
                    }
                    document.getElementById('chat-input').focus();
                }
            }
            function handleKeyPress(event) {
                if (event.key === 'Enter') { sendMessage(); }
            }
            function parseMarkdown(text) {
                var html = text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
                html = html.replace(/^### (.+)$/gm, '<h4 style="margin:8px 0 4px;font-size:13px;">$1</h4>');
                html = html.replace(/^## (.+)$/gm, '<h3 style="margin:8px 0 4px;font-size:14px;">$1</h3>');
                html = html.replace(/^# (.+)$/gm, '<h2 style="margin:8px 0 4px;font-size:15px;">$1</h2>');
                html = html.replace(/^\* (.+)$/gm, '<li style="margin-left:16px;list-style:disc;">$1</li>');
                html = html.replace(/^- (.+)$/gm, '<li style="margin-left:16px;list-style:disc;">$1</li>');
                html = html.replace(/^\d+\. (.+)$/gm, '<li style="margin-left:16px;list-style:decimal;">$1</li>');
                html = html.replace(/(<li[^>]*>.*<\/li>)\n(<li)/g, '$1$2');
                html = html.replace(/\n\n/g, '</p><p style="margin:8px 0;">');
                html = html.replace(/\n/g, '<br>');
                html = '<p style="margin:0;">' + html + '</p>';
                html = html.replace(/<p style="margin:0;"><\/p>/g, '');
                return html;
            }
            function loadHistory() {
                fetch('/api/chat/history')
                    .then(function (response) { return response.json(); })
                    .then(function (history) {
                        if (history && history.length > 0) {
                            var messagesContainer = document.getElementById('chat-messages');
                            messagesContainer.innerHTML = '<div class="chat-message bot">Hi! I\'m your book assistant. Tell me what kind of book you\'re looking for and I\'ll help you find it! ðŸ“–</div>';
                            history.forEach(function (msg) {
                                var div = document.createElement('div');
                                div.className = 'chat-message ' + msg.role;
                                if (msg.role === 'bot') {
                                    div.innerHTML = parseMarkdown(msg.content);
                                } else {
                                    div.textContent = msg.content;
                                }
                                messagesContainer.appendChild(div);
                            });
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }
                    });
            }
            function clearHistory() {
                fetch('/api/chat/clear', { method: 'POST' })
                    .then(function () {
                        var messagesContainer = document.getElementById('chat-messages');
                        messagesContainer.innerHTML = '<div class="chat-message bot">Hi! I\'m your book assistant. Tell me what kind of book you\'re looking for and I\'ll help you find it! ðŸ“–</div>';
                    });
            }
            function sendMessage() {
                var input = document.getElementById('chat-input');
                var message = input.value.trim();
                if (!message) return;
                var messagesContainer = document.getElementById('chat-messages');
                var userMsgDiv = document.createElement('div');
                userMsgDiv.className = 'chat-message user';
                userMsgDiv.textContent = message;
                messagesContainer.appendChild(userMsgDiv);
                input.value = '';
                input.disabled = true;
                document.querySelector('.chat-send').disabled = true;
                var loadingDiv = document.createElement('div');
                loadingDiv.className = 'chat-message loading';
                loadingDiv.textContent = 'Thinking';
                messagesContainer.appendChild(loadingDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                })
                    .then(function (response) { return response.json(); })
                    .then(function (data) {
                        messagesContainer.removeChild(loadingDiv);
                        var botMsgDiv = document.createElement('div');
                        botMsgDiv.className = 'chat-message bot';
                        var responseText = data.response || data.error || 'Sorry, something went wrong.';
                        botMsgDiv.innerHTML = parseMarkdown(responseText);
                        messagesContainer.appendChild(botMsgDiv);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    })
                    .catch(function (error) {
                        messagesContainer.removeChild(loadingDiv);
                        var errorDiv = document.createElement('div');
                        errorDiv.className = 'chat-message bot';
                        errorDiv.textContent = 'Sorry, I could not connect. Please try again.';
                        messagesContainer.appendChild(errorDiv);
                    })
                    .finally(function () {
                        input.disabled = false;
                        document.querySelector('.chat-send').disabled = false;
                        input.focus();
                    });
            }
        </script>
    </div>
</body>

</html>