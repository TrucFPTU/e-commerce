<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<th:block th:fragment="body">
    <div id="dashboard-content">
        <!-- Loading State -->
        <div class="loading" id="loading-spinner">
            <div class="spinner"></div>
            <p style="font-size: 16px; font-weight: 500;">ƒêang t·∫£i d·ªØ li·ªáu th·ªëng k√™...</p>
        </div>

        <!-- Main Dashboard Content (hidden until data loads) -->
        <div id="main-content" style="display: none;">
            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card primary">
                    <div class="stat-header">
                        <div class="stat-label">T·ªïng ƒë∆°n h√†ng</div>
                        <div class="stat-icon">üì¶</div>
                    </div>
                    <div class="stat-value" id="totalOrders">0</div>
                    <div class="stat-change">T·∫•t c·∫£ ƒë∆°n h√†ng trong h·ªá th·ªëng</div>
                </div>
                
                <div class="stat-card success">
                    <div class="stat-header">
                        <div class="stat-label">T·ªïng doanh thu</div>
                        <div class="stat-icon">üí∞</div>
                    </div>
                    <div class="stat-value" id="totalRevenue">0 ƒë</div>
                    <div class="stat-change">T·ª´ ƒë∆°n ho√†n th√†nh & ƒëang giao</div>
                </div>
                
                <div class="stat-card warning">
                    <div class="stat-header">
                        <div class="stat-label">T·ªïng kh√°ch h√†ng</div>
                        <div class="stat-icon">üë•</div>
                    </div>
                    <div class="stat-value" id="totalCustomers">0</div>
                    <div class="stat-change">Kh√°ch h√†ng ƒë√£ ƒëƒÉng k√Ω</div>
                </div>
                
                <div class="stat-card danger">
                    <div class="stat-header">
                        <div class="stat-label">T·ªïng s·∫£n ph·∫©m</div>
                        <div class="stat-icon">üìö</div>
                    </div>
                    <div class="stat-value" id="totalProducts">0</div>
                    <div class="stat-change">S√°ch trong kho</div>
                </div>
            </div>

            <!-- Order Status -->
            <div class="chart-container" style="margin-bottom: 32px;">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">üìä Tr·∫°ng th√°i ƒë∆°n h√†ng</h3>
                        <div class="chart-subtitle">Ph√¢n lo·∫°i theo tr·∫°ng th√°i x·ª≠ l√Ω</div>
                    </div>
                </div>
                <div class="order-status-grid">
                    <div class="status-card">
                        <div class="icon">‚è≥</div>
                        <div class="count" id="pendingOrders">0</div>
                        <div class="label">Ch·ªù thanh to√°n</div>
                    </div>
                    <div class="status-card">
                        <div class="icon">üì¶</div>
                        <div class="count" id="processingOrders">0</div>
                        <div class="label">ƒêang x·ª≠ l√Ω</div>
                    </div>
                    <div class="status-card">
                        <div class="icon">üöö</div>
                        <div class="count" id="shippedOrders">0</div>
                        <div class="label">ƒêang giao</div>
                    </div>
                    <div class="status-card">
                        <div class="icon">‚úÖ</div>
                        <div class="count" id="completedOrders">0</div>
                        <div class="label">Ho√†n th√†nh</div>
                    </div>
                    <div class="status-card">
                        <div class="icon">‚ùå</div>
                        <div class="count" id="cancelledOrders">0</div>
                        <div class="label">ƒê√£ h·ªßy</div>
                    </div>
                </div>
            </div>

            <!-- Revenue Chart -->
            <div class="chart-container full-width">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">üìà Bi·ªÉu ƒë·ªì doanh thu</h3>
                        <div class="chart-subtitle">Doanh thu 30 ng√†y g·∫ßn nh·∫•t</div>
                    </div>
                </div>
                <canvas id="revenueChart"></canvas>
            </div>

            <!-- Charts Grid -->
            <div class="charts-grid">
                <!-- Order Status Pie Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">ü•ß Ph√¢n b·ªï ƒë∆°n h√†ng</h3>
                            <div class="chart-subtitle">Theo tr·∫°ng th√°i</div>
                        </div>
                    </div>
                    <canvas id="orderStatusChart"></canvas>
                </div>

                <!-- Top Categories Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">üìä Top danh m·ª•c</h3>
                            <div class="chart-subtitle">5 danh m·ª•c b√°n ch·∫°y nh·∫•t</div>
                        </div>
                    </div>
                    <canvas id="categoriesChart"></canvas>
                </div>
            </div>

            <!-- Top Products Table -->
            <div class="chart-container">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">üèÜ Top 10 s√°ch b√°n ch·∫°y nh·∫•t</h3>
                        <div class="chart-subtitle">S·∫Øp x·∫øp theo s·ªë l∆∞·ª£ng b√°n</div>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="top-items-table" id="topProductsTable">
                        <thead>
                            <tr>
                                <th style="width: 80px;">#</th>
                                <th>T√™n s√°ch</th>
                                <th style="width: 150px; text-align: right;">S·ªë l∆∞·ª£ng b√°n</th>
                                <th style="width: 180px; text-align: right;">Doanh thu</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(Math.round(amount)) + ' ƒë';
        }

        // Format number
        function formatNumber(num) {
            return new Intl.NumberFormat('vi-VN').format(num);
        }

        // Load all dashboard data
        async function loadDashboard() {
            try {
                // Load stats
                const statsResponse = await fetch('/admin/dashboard/api/stats');
                if (!statsResponse.ok) throw new Error('Failed to load stats');
                const stats = await statsResponse.json();

                // Update stats cards
                document.getElementById('totalOrders').textContent = formatNumber(stats.totalOrders);
                document.getElementById('totalRevenue').textContent = formatCurrency(stats.totalRevenue);
                document.getElementById('totalCustomers').textContent = formatNumber(stats.totalCustomers);
                document.getElementById('totalProducts').textContent = formatNumber(stats.totalProducts);

                // Update order status
                document.getElementById('pendingOrders').textContent = formatNumber(stats.awaitingPaymentOrders);
                document.getElementById('processingOrders').textContent = formatNumber(stats.processingOrders);
                document.getElementById('shippedOrders').textContent = formatNumber(stats.shippingOrders);
                document.getElementById('completedOrders').textContent = formatNumber(stats.completedOrders);
                document.getElementById('cancelledOrders').textContent = formatNumber(stats.cancelledOrders);

                // Load revenue chart
                const revenueResponse = await fetch('/admin/dashboard/api/revenue?days=30');
                if (!revenueResponse.ok) throw new Error('Failed to load revenue data');
                const revenueData = await revenueResponse.json();
                createRevenueChart(revenueData);

                // Create order status pie chart
                createOrderStatusChart(stats);

                // Load top products
                const productsResponse = await fetch('/admin/dashboard/api/top-products?limit=10');
                if (!productsResponse.ok) throw new Error('Failed to load top products');
                const topProducts = await productsResponse.json();
                populateTopProductsTable(topProducts);

                // Load top categories
                const categoriesResponse = await fetch('/admin/dashboard/api/top-categories?limit=5');
                if (!categoriesResponse.ok) throw new Error('Failed to load top categories');
                const topCategories = await categoriesResponse.json();
                createCategoriesChart(topCategories);

                // Hide loading, show content
                document.getElementById('loading-spinner').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';

            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('loading-spinner').innerHTML = 
                    '<div class="error-state">' +
                    '<div class="error-state-icon">‚ùå</div>' +
                    '<p style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">L·ªói khi t·∫£i d·ªØ li·ªáu</p>' +
                    '<p style="font-size: 14px;">Vui l√≤ng th·ª≠ l·∫°i sau ho·∫∑c li√™n h·ªá qu·∫£n tr·ªã vi√™n.</p>' +
                    '</div>';
            }
        }

        // Create revenue line chart
        function createRevenueChart(data) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            if (data.length === 0) {
                ctx.canvas.parentElement.innerHTML = 
                    '<div class="empty-state">' +
                    '<div class="empty-state-icon">üìä</div>' +
                    '<div class="empty-state-text">Ch∆∞a c√≥ d·ªØ li·ªáu doanh thu</div>' +
                    '</div>';
                return;
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => {
                        const date = new Date(d.date);
                        return date.getDate() + '/' + (date.getMonth() + 1);
                    }),
                    datasets: [{
                        label: 'Doanh thu (VNƒê)',
                        data: data.map(d => d.revenue),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 13, weight: '600' }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: '600' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: function(context) {
                                    return 'Doanh thu: ' + formatCurrency(context.parsed.y);
                                },
                                afterLabel: function(context) {
                                    const item = data[context.dataIndex];
                                    return 'ƒê∆°n h√†ng: ' + item.orderCount;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                font: { size: 12 },
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000) + 'M ƒë';
                                    }
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: { size: 12 }
                            }
                        }
                    }
                }
            });
        }

        // Create order status pie chart
        function createOrderStatusChart(stats) {
            const ctx = document.getElementById('orderStatusChart').getContext('2d');
            const total = stats.awaitingPaymentOrders + stats.processingOrders + stats.shippingOrders + 
                         stats.completedOrders + stats.cancelledOrders;
            
            if (total === 0) {
                ctx.canvas.parentElement.innerHTML = 
                    '<div class="empty-state">' +
                    '<div class="empty-state-icon">ü•ß</div>' +
                    '<div class="empty-state-text">Ch∆∞a c√≥ ƒë∆°n h√†ng</div>' +
                    '</div>';
                return;
            }
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ch·ªù thanh to√°n', 'ƒêang x·ª≠ l√Ω', 'ƒêang giao', 'Ho√†n th√†nh', 'ƒê√£ h·ªßy'],
                    datasets: [{
                        data: [
                            stats.awaitingPaymentOrders,
                            stats.processingOrders,
                            stats.shippingOrders,
                            stats.completedOrders,
                            stats.cancelledOrders
                        ],
                        backgroundColor: [
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(153, 102, 255, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(255, 99, 132, 0.8)'
                        ],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 12, weight: '500' }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return label + ': ' + value + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Create categories bar chart
        function createCategoriesChart(categories) {
            const ctx = document.getElementById('categoriesChart').getContext('2d');
            
            if (categories.length === 0) {
                ctx.canvas.parentElement.innerHTML = 
                    '<div class="empty-state">' +
                    '<div class="empty-state-icon">üìä</div>' +
                    '<div class="empty-state-text">Ch∆∞a c√≥ d·ªØ li·ªáu danh m·ª•c</div>' +
                    '</div>';
                return;
            }
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories.map(c => c.categoryName),
                    datasets: [{
                        label: 'Doanh thu (VNƒê)',
                        data: categories.map(c => c.totalRevenue),
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return 'Doanh thu: ' + formatCurrency(context.parsed.x);
                                },
                                afterLabel: function(context) {
                                    const item = categories[context.dataIndex];
                                    return 'S·ªë l∆∞·ª£ng: ' + formatNumber(item.totalSold);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                font: { size: 11 },
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000) + 'M';
                                    }
                                    return value;
                                }
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: { size: 12, weight: '500' }
                            }
                        }
                    }
                }
            });
        }

        // Populate top products table
        function populateTopProductsTable(products) {
            const tbody = document.querySelector('#topProductsTable tbody');
            tbody.innerHTML = '';
            
            if (products.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 12px; opacity: 0.5;">üìö</div>
                            <div style="color: #999;">Ch∆∞a c√≥ d·ªØ li·ªáu s·∫£n ph·∫©m b√°n ch·∫°y</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            products.forEach((product, index) => {
                const badge = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
                const row = `
                    <tr>
                        <td>${badge ? '<span class="badge ' + badge + '">#' + (index + 1) + '</span>' : '#' + (index + 1)}</td>
                        <td style="font-weight: 500;">${product.productName}</td>
                        <td style="text-align: right; font-weight: 600;">${formatNumber(product.totalSold)}</td>
                        <td style="text-align: right; color: #4CAF50; font-weight: 600;">${formatCurrency(product.totalRevenue)}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }



        // Load dashboard when page loads
        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</th:block>

</html>
